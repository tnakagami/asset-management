{% extends 'base.html' %}
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}

{% block header %}
<style>
  /* For Chart.js */
  .wrap-bar-chart {
    position: relative;
    height: 100vh;
  }
</style>
{% endblock %}

{% block content %}
{% include 'breadcrumbs.html' with title=_("Dashboard") %}
<div class="row justify-content-center">
  <div class="col">
  {% if snapshots %}
  <div class="row row-cols-1 g-2">
    <div class="col">
      <p class="fs-5">{% trans "Target snapshot" %}</p>
      <select name="snapshot" id="all-snapshots" class="form-control">{% for instance in snapshots %}
        <option value="{{ instance.uuid }}"{% if forloop.first %} selected{% endif %}>{{ instance.title }}</option>{% endfor %}
      </select>
    </div>
    <div class="col">
      <p class="fs-5">{% trans "Sort type" %}</p>
      <select name="sortType" id="sort-type" class="form-control">
        <option value="none" selected>{% trans "Without sorting" %}</option>
        <option value="asc">{% trans "Ascending order" %}</option>
        <option value="desc">{% trans "Descending order" %}</option>
      </select>
    </div>
    <div class="col">
      <p class="fs-5">{% trans "Collection type" %}</p>
      <select name="collectionType" id="collection-type" class="form-control">
        <option value="pValue" selected>{% trans "Using purchased value" %}</option>
        <option value="cStock">{% trans "Using current stock price" %}</option>
      </select>
    </div>
    <div class="col">
      <nav>
        <div class="nav nav-pills flex-column flex-md-row" id="management-tab" role="tablist">
          <button
            type="button"
            class="flex-md-fill text-md-center nav-link active"
            id="portfolio-tab"
            data-bs-toggle="tab"
            data-bs-target="#portfolio-tab-pane"
            role="tab"
            aria-controls="portfolio-tab-pane"
            aria-selected="true"
          >
            {% trans "Portfolio" %}
          </button>
          <button
            type="button"
            class="flex-md-fill text-md-center nav-link"
            id="sector-tab"
            data-bs-toggle="tab"
            data-bs-target="#sector-tab-pane"
            role="tab"
            aria-controls="sector-tab-pane"
            aria-selected="false"
          >
            {% trans "Sector" %}
          </button>
          <button
            type="button"
            class="flex-md-fill text-md-center nav-link"
            id="economic-trend-tab"
            data-bs-toggle="tab"
            data-bs-target="#economic-trend-tab-pane"
            role="tab"
            aria-controls="economic-trend-tab-pane"
            aria-selected="false"
          >
            {% trans "Economic trend" %}
          </button>
          <button
            type="button"
            class="flex-md-fill text-md-center nav-link"
            id="asset-diff-tab"
            data-bs-toggle="tab"
            data-bs-target="#asset-diff-tab-pane"
            role="tab"
            aria-controls="asset-diff-tab-pane"
            aria-selected="false"
          >
            {% trans "Diff" %}
          </button>
          <button
            type="button"
            class="flex-md-fill text-md-center nav-link"
            id="all-assets-tab"
            data-bs-toggle="tab"
            data-bs-target="#all-assets-tab-pane"
            role="tab"
            aria-controls="all-assets-tab-pane"
            aria-selected="false"
          >
            {% trans "Assets" %}
          </button>
        </div>
      </nav>
      <div class="tab-content my-2 pt-1 border-top border-2" id="management-content">
        <div
          class="tab-pane fade show active"
          id="portfolio-tab-pane"
          role="tabpanel"
          aria-labelledby="portfolio-tab"
          tabindex="0"
        >
          <div class="row row-cols-1 row-cols-md-2 g-2">
            <div class="col">
              <canvas id="stock-portfolio-chart" class="w-100"></canvas>
            </div>
            <div class="col">
              <canvas id="dividend-portfolio-chart" class="w-100"></canvas>
            </div>
          </div>
        </div>
        <div
          class="tab-pane fade"
          id="sector-tab-pane"
          role="tabpanel"
          aria-labelledby="sector-tab"
          tabindex="0"
        >
          <div class="row row-cols-1 row-cols-md-2 g-2">
            <div class="col">
              <canvas id="sector-price-chart" class="w-100"></canvas>
            </div>
            <div class="col">
              <canvas id="sector-dividend-chart" class="w-100"></canvas>
            </div>
          </div>
        </div>
        <div
          class="tab-pane fade"
          id="economic-trend-tab-pane"
          role="tabpanel"
          aria-labelledby="economic-trend-tab"
          tabindex="0"
        >
          <div class="row row-cols-1 row-cols-md-2 g-2">
            <div class="col">
              <canvas id="trend-price-chart" class="w-100"></canvas>
            </div>
            <div class="col">
              <canvas id="trend-dividend-chart" class="w-100"></canvas>
            </div>
          </div>
        </div>
        <div
          class="tab-pane fade"
          id="asset-diff-tab-pane"
          role="tabpanel"
          aria-labelledby="asset-diff-tab"
          tabindex="0"
        >
          <div class="row">
            <div class="col wrap-bar-chart">
              <canvas id="asset-diff-chart" class="w-100"></canvas>
            </div>
          </div>
        </div>
        <div
          class="tab-pane fade"
          id="all-assets-tab-pane"
          role="tabpanel"
          aria-labelledby="all-assets-tab"
          tabindex="0"
        >
          <div class="row row-cols-1 g-2">
            <div class="col">
              <h3 class="mt-2">{% trans "Purchased stocks distribution" %}</h3>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th scope="col">{% trans "No." %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Code" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Stock name" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Industry" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Economic trend" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Dividend" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Dividend yield" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Value" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Count" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Diff" %}</th>
                    </tr>
                  </thead>
                  <tbody id="all-assets-list" class="table-group-divider">
                  </tbody>
                  <tfoot class="table-group-divider text-left" id="asset-totals">
                    <tr>
                      <th scope="row" colspan="5" class="text-center">{% trans "Total except cash" %}</th>
                      <th><span name="total-asset-dividend"></span></th>
                      <th><span name="average-asset-yield"></span>&#37;</th>
                      <th><span name="total-asset-value"></span></th>
                      <th><span name="total-asset-count"></span></th>
                      <th><span name="total-asset-diff"></span></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
            <div class="col">
              <h3>{% trans "Owned sectors distribution" %}</h3>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th scope="col">{% trans "No." %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Industry" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Economic trend" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "#Target stocks" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Dividend" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Value" %}</th>
                      <th scope="col" class="text-nowrap">{% trans "Diff" %}</th>
                    </tr>
                  </thead>
                  <tbody id="all-sectors-list" class="table-group-divider">
                  </tbody>
                  <tfoot class="table-group-divider text-left" id="sector-totals">
                    <tr>
                      <th scope="row" colspan="3" class="text-center">{% trans "Total" %}</th>
                      <th><span name="total-sector-count"></span></th>
                      <th><span name="total-sector-dividend"></span></th>
                      <th><span name="total-sector-value"></span></th>
                      <th><span name="total-sector-diff"></span></th>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <p>{% trans "There is no snapshots. Please add your snapshots in the following link." %}</p>
  <p>
    <a
      href="{% url 'stock:register_snapshot' %}"
      class="btn btn-outline-primary w-100 custom-boxshadow"
    >
      {% trans "Register snapshot" %}
    </a>
  </p>
  {% endif %}
  </div>
</div>

<div class="modal" id="stock-modal" tabindex="-1" aria-labelledby="stock-label" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <p class="modal-title fs-5" id="stock-label">{% trans "Detail of target stock" %}</p>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col" class="text-nowrap fw-bold">{% trans "Element" %}</th>
                <th scope="col" class="text-nowrap">{% trans "Value" %}</th>
              </tr>
            </thead>
            <tbody class="table-group-divider">
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Code" %}</td>
                <td class="text-nowrap"><span data-target="code"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Stock name" %}</td>
                <td class="text-break"><span data-target="name"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Industry" %}</td>
                <td class="text-nowrap"><span data-target="industry"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Stock price" %}</td>
                <td class="text-nowrap"><span data-target="price"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Dividend" %}</td>
                <td class="text-nowrap"><span data-target="dividend"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Dividend yield" %}</td>
                <td class="text-nowrap"><span data-target="yield"></span>&#37;</td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Price Earnings Ratio" %}</td>
                <td class="text-nowrap"><span data-target="per"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Price Book-value Ratio" %}</td>
                <td class="text-nowrap"><span data-target="pbr"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Earnings Per Share" %}</td>
                <td class="text-nowrap"><span data-target="eps"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Book value Per Share" %}</td>
                <td class="text-nowrap"><span data-target="bps"></span></td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Return On Equity" %}</td>
                <td class="text-nowrap"><span data-target="roe"></span>&#37;</td>
              </tr>
              <tr>
                <td scope="row" class="text-nowrap fw-bold">{% trans "Equity Ratio" %}</td>
                <td class="text-nowrap"><span data-target="er"></span>&#37;</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <div class="row w-100">
          <div class="col">
            <button type="button" class="btn btn-secondary w-100 custom-boxshadow" data-bs-dismiss="modal">
              {% trans "Close" %}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<template id="asset-tbody-template">
<tr>
  <td scope="row"><span class="asset-idx"></span></td>
  <td><span class="asset-code"></span></td>
  <td><span class="asset-name" tabindex="0"></span></td>
  <td><span class="asset-industry"></span></td>
  <td><span class="asset-trend"></span></td>
  <td><span class="asset-realDividend"></span></td>
  <td><span class="asset-yield"></span>&#37;</td>
  <td><span class="asset-value"></span></td>
  <td><span class="asset-count"></span></td>
  <td><span class="asset-diff"></span></td>
</tr>
</template>

<template id="sector-tbody-template">
<tr>
  <td scope="row"><span class="sector-idx"></span></td>
  <td><span class="sector-industry"></span></td>
  <td><span class="sector-trend"></span></td>
  <td><span class="sector-count"></span></td>
  <td><span class="sector-dividend"></span></td>
  <td><span class="sector-value"></span></td>
  <td><span class="sector-diff"></span></td>
</tr>
</template>
{% endblock %}

{% block bodyjs %}
{% for instance in snapshots %}
  {{ instance.get_jsonfield }}{% endfor %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"
        integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
(function () {
  const createChartData = (data, sortCallback, collectType) => {
    const _getTrend = (isDefensive) => {
      const trendNameList = ['{% trans "Defensive" %}', '{% trans "Economically sensitive" %}'];
      const trendIdx = isDefensive ? 0 : 1;
      const out = {
        isDefensive: isDefensive,
        idx: trendIdx,
        name: trendNameList[trendIdx],
      };

      return out;
    };
    const _getValArr = (arr) => arr.map((item) => {
      const patterns = {
        pValue: item.value,
        cStock: item.options.price * item.count,
      };
      const value = patterns[collectType];

      return value;
    });
    const _getDiffArr = (arr) => arr.map((item) => item.diff);
    const _getDividendArr = (arr) => arr.map((item) => item.realDividend);
    const _calcTotal = (arr, initVal=0.0) => arr.reduce((acc, val) => acc + val, initVal);
    const _stockValSum = (arr, initVal=0.0) => _calcTotal(_getValArr(arr), initVal);
    const _dividendValSum = (arr, initVal=0.0) => _calcTotal(_getDividendArr(arr), initVal);
    const _generateColorPalette = (len, offset=180) => {
      const hueArray = (() => {
        const scaler = (len > 360) ? 1.0 : 360.0 / len;

        return [...Array(len)].map((_, idx) => Math.floor(idx * scaler + offset) % 360);
      })();
      const colors = hueArray.map((val) => `hsla(${val}, 82%, 71%, 0.85)`);

      return colors;
    };
    const cash = data.cash.balance;
    const originalStocks = data.purchased_stocks.map((record) => {
      const _getName = (item) => {
        const lang = '{{ LANGUAGE_CODE|stringformat:"s" }}';
        const ret = item.name || item.names[lang] || item.names.en;

        return ret;
      };
      const _scaler = (val) => val * record.count;
      const _stock = record.stock;
      const diff = _scaler(_stock.price) - _scaler(record.price);
      const trendStat = _getTrend(_stock.industry.is_defensive);

      return {
        name: _getName(_stock),
        code: _stock.code,
        industry: _getName(_stock.industry),
        dividend: _stock.dividend,
        realDividend: _scaler(_stock.dividend),
        isDefensive: trendStat.isDefensive,
        trend: trendStat.name,
        price: record.price,
        count: record.count,
        diff: diff,
        options: {
          price: _stock.price,
          per: _stock.per,
          pbr: _stock.pbr,
          eps: _stock.eps,
          bps: _stock.bps,
          roe: _stock.roe,
          er: _stock.er,
        },
      };
    });
    const stocks = (() => {
      const purchasedPairs = {};
      const _calcValue = (item) => item.price * item.count;
      const _calcYield = (target) => target.realDividend / target.value * 100.0;

      for (const item of originalStocks) {
        const code = item.code;

        if (Object.hasOwn(purchasedPairs, code)) {
          purchasedPairs[code].realDividend += item.realDividend;
          purchasedPairs[code].value += _calcValue(item);
          purchasedPairs[code].count += item.count;
          purchasedPairs[code].diff += item.diff;
        }
        else {
          purchasedPairs[code] = {
            name: item.name,
            code: code,
            industry: item.industry,
            dividend: item.dividend,
            realDividend: item.realDividend,
            yield: 0,
            isDefensive: item.isDefensive,
            trend: item.trend,
            value: _calcValue(item),
            count: item.count,
            diff: item.diff,
            options: item.options,
          };
        }
        purchasedPairs[code].yield = _calcYield(purchasedPairs[code]);
      }

      return Object.values(purchasedPairs);
    })();
    const records = [{
      name: '{% trans "Cash" %}',
      code: '-',
      industry: '-',
      dividend: 0,
      realDividend: 0,
      yield: 0,
      isDefensive: undefined,
      trend: '-',
      value: (cash || 0),
      count: 0,
      diff: 0,
      options: undefined,
    }].concat(stocks);
    // Define name lists
    const stockNameList = [records[0].name].concat(stocks.map((item) => `${item.name}(${item.code})`));
    const sectorList = (() => {
      const configs = stocks.reduce((pairs, item) => {
        const industry = item.industry;
        const trendStat = _getTrend(item.isDefensive);
        pairs[industry] = {
          industry: industry,
          isDefensive: trendStat.isDefensive,
          trendIdx: trendStat.idx,
          trendType: trendStat.name,
          displayName: `${industry}(${trendStat.name})`,
        };

        return pairs;
      }, {});
      const arr = Object.values(configs).sort((le, re) => {
        // le: left element
        // re: right element
        const sign = 1; // ASC
        const compare = ((val) => (val > 0) ? sign : ((val < 0) ? (-sign) : 0));
        const indexOrder = compare(le.trendIdx - re.trendIdx);
        const out = (indexOrder !== 0) ? indexOrder : compare(le.industry.localeCompare(re.industry));

        return out;
      });

      return arr;
    })();

    const sectorNameList = sectorList.map((item) => item.displayName);
    // Define color dictionaries
    const stockColorDict = (() => {
      const arr = stockNameList.slice(1);
      const palette = _generateColorPalette(arr.length);
      const initVal = {[records[0].name]: '#C9CBCF'};
      const out = arr.reduce((pairs, name, idx) => {
        pairs[name] = palette[idx];

        return pairs;
      }, initVal);

      return out;
    })();
    const sectorColorDict = (() => {
      const palette = _generateColorPalette(sectorNameList.length);
      const out = sectorNameList.reduce((pairs, name, idx) => {
        pairs[name] = palette[idx];

        return pairs;
      }, {});

      return out;
    })();
    const trendColorDict = (() => {
      const defStat = _getTrend(true);
      const notDefStat = _getTrend(false);
      const out = {
        [defStat.name]: 'rgba(136, 200, 244, 0.9)',
        [notDefStat.name]: 'rgba(243, 136, 158, 0.9)',
      };

      return out;
    })();
    const diffColorDict = stockNameList.slice(1).reduce((pairs, name) => {
      pairs[name] = 'rgba(136, 200, 244, 0.9)';

      return pairs;
    }, {});
    // Define chart data
    const sectors = sectorList.map((config) => {
      const industry = config.industry;
      const targets = records.filter((item) => item.industry === industry);
      const totalDividend = _dividendValSum(targets);
      const totalPrice = _stockValSum(targets);
      const totalDiff = _calcTotal(_getDiffArr(targets));
      const out = {
        industry: industry,
        isDefensive: config.isDefensive,
        trend: config.trendType,
        value: totalPrice,
        count: targets.length,
        dividend: totalDividend,
        diff: totalDiff,
      };

      return out;
    });
    const pairs = {
      dividendPortfolioData: {
        title: '{% trans "Portfolio (dividend)" %}',
        labels: stockNameList.slice(1),
        colors: stockColorDict,
        datasets: [{
          label: '{% trans "Dividend" %}',
          data: _getDividendArr(records.slice(1)),
        }],
      },
      stockPortfolioData: {
        title: '{% trans "Portfolio (price)" %}',
        labels: stockNameList.slice(1),
        colors: stockColorDict,
        datasets: [{
          label: '{% trans "Stock price" %}',
          data: _getValArr(records.slice(1)),
        }],
      },
      sectorDividendData: {
        title: '{% trans "Sector distribution (dividend)" %}',
        labels: sectorNameList,
        colors: sectorColorDict,
        datasets: [{
          label: '{% trans "Dividend" %}',
          data: sectors.map((item) => item.dividend),
        }],
      },
      sectorPriceData: {
        title: '{% trans "Sector distribution (price)" %}',
        labels: sectorNameList,
        colors: sectorColorDict,
        datasets: [{
          label: '{% trans "Price" %}',
          data: sectors.map((item) => item.value),
        }],
      },
      trendDividendData: {
        title: '{% trans "Economic trend (dividend)" %}',
        labels: Object.keys(trendColorDict),
        colors: trendColorDict,
        datasets: [{
          label: '{% trans "Dividend" %}',
          data: [true, false].map((isDefensive) => {
            const targets = sectors.filter((item) => item.isDefensive === isDefensive);
            const total = _calcTotal(targets.map((item) => item.dividend));

            return total;
          }),
        }],
      },
      trendPriceData: {
        title: '{% trans "Economic trend (price)" %}',
        labels: Object.keys(trendColorDict),
        colors: trendColorDict,
        datasets: [{
          label: '{% trans "Price" %}',
          data: [true, false].map((isDefensive) => {
            const targets = sectors.filter((item) => item.isDefensive === isDefensive);
            const total = _calcTotal(targets.map((item) => item.value));

            return total;
          }),
        }],
      },
      assetDiffData: {
        title: '{% trans "Difference between stock price and purchased price" %}',
        labels: stockNameList.slice(1),
        colors: diffColorDict,
        datasets: [{
          axis: 'y',
          label: '{% trans "Diff" %}',
          data: _getDiffArr(records.slice(1)),
        }],
      },
    };
    const output = Object.entries(pairs).reduce((accItems, [key, item]) => {
      const dataset = item.datasets[0];
      const target = dataset.data;
      const indices = target.map((_, idx) => idx);
      const sortedIndices = indices.sort((li, ri) => sortCallback(target[li], target[ri]));
      const cores = {
        label: dataset.label,
        data: sortedIndices.map((idx) => target[idx]),
        backgroundColor: sortedIndices.map((idx) => item.colors[item.labels[idx]]),
      };
      if (dataset.axis) {
        cores.indexAxis = dataset.axis;
      }
      // Store data
      accItems[key] = {
        title: item.title,
        labels: sortedIndices.map((idx) => item.labels[idx]),
        datasets: [cores],
      };

      return accItems;
    }, {});
    output.sectors = sectors;
    output.records = records;

    return output;
  };
  const updateTable = (records, sectors) => {
    const updateNodeStatus = (item, element) => {
      if (item.options) {
        const get_yield = (price, dividend) => ((dividend > 0) ? (dividend / price * 100.0).toFixed(2) : '0.00');
        element.dataset.name = item.name;
        element.dataset.code = item.code;
        element.dataset.industry = item.industry;
        element.dataset.price = item.options.price.toFixed(2);
        element.dataset.dividend = item.dividend.toFixed(2);
        element.dataset.yield = get_yield(item.options.price, item.dividend);
        element.dataset.per = item.options.per.toFixed(2);
        element.dataset.pbr = item.options.pbr.toFixed(2);
        element.dataset.eps = item.options.eps.toFixed(2);
        element.dataset.bps = item.options.bps.toFixed(2);
        element.dataset.roe = item.options.roe.toFixed(2);
        element.dataset.er = item.options.er.toFixed(2);
        element.classList.add('text-decoration-underline', 'text-primary');
        // Add click event
        element.addEventListener('click', () => {
          const columns = Object.freeze([
            'code', 'name', 'industry', 'price', 'dividend',
            'yield', 'per', 'pbr', 'eps', 'bps', 'roe', 'er',
          ]);
          const pattern = new RegExp('^-[0-9,]+.?[0-9]+$');
          const isNegative = (val) => pattern.test(val);
          // Update modal data and show modal
          for (const key of columns) {
            const node = document.querySelector(`[data-target="${key}"]`);
            const value = element.dataset[key];
            node.textContent = value;

            if (isNegative(value)) {
              node.parentElement.classList.add('text-danger');
            }
            else {
              node.parentElement.classList.remove('text-danger');
            }
          }
          const stockModal = new bootstrap.Modal('#stock-modal');
          stockModal.show();
        });
        // Add key press event
        element.addEventListener('keyup', (event) => {
          if (event.key === 'Enter') {
            element.click();
          }
        });
      }
    };
    //
    // Update asset table
    //
    (() => {
      const tbody = document.getElementById('all-assets-list');
      const tfoot = document.getElementById('asset-totals');
      const template = document.getElementById('asset-tbody-template');
      const nodeList = {
        'idx': (_, idx) => idx,
        'code': (val, _) => val,
        'name': (val, _) => val,
        'industry': (val, _) => val,
        'trend': (val, _) => val,
        'realDividend': (val, _) => val.toLocaleString(),
        'yield': (val, _) => val.toFixed(2),
        'value': (val, _) => val.toLocaleString(),
        'count': (val, _) => val.toLocaleString(),
        'diff': (val, _) => val.toLocaleString(),
      };
      const totals = {
        dividend: 0,
        value: 0,
        count: 0,
        diff: 0,
      };
      tbody.innerHTML = '';
      // Set each record
      records.forEach((item, idx) => {
        const clone = template.content.cloneNode(true);

        for (const [key, callback] of Object.entries(nodeList)) {
          const element = clone.querySelector(`.asset-${key}`);
          const val = item[key];
          element.textContent = callback(val, idx);

          if ((key === 'diff') && (val < 0)) {
            element.classList.add('text-danger');
          }
          else if (key === 'name') {
            updateNodeStatus(item, element);
          }
        }
        totals.dividend += item.realDividend;
        totals.value += item.value;
        totals.count += item.count;
        totals.diff += item.diff;
        tbody.appendChild(clone);
      });
      // Ignore cash
      totals.value -= records[0].value;
      // Set total value
      ['dividend', 'value', 'count', 'diff'].forEach((key) => {
        const element = tfoot.querySelector(`th > span[name="total-asset-${key}"]`);
        const val = totals[key];
        element.textContent = val.toLocaleString();

        if ((key === 'diff') && (val < 0)) {
          element.classList.add('text-danger');
        }
        else {
          element.classList.remove('text-danger');
        }
      });
      // Calculate average dividend yield and reflect it to footer
      const yieldEl = tfoot.querySelector('th > span[name="average-asset-yield"]');
      const yieldVal = totals.dividend / totals.value * 100.0;
      yieldEl.textContent = yieldVal.toFixed(2);
    })();
    //
    // Update sector table
    //
    (() => {
      const tbody = document.getElementById('all-sectors-list');
      const tfoot = document.getElementById('sector-totals');
      const template = document.getElementById('sector-tbody-template');
      const nodeList = {
        'idx': (_, idx) => idx + 1,
        'industry': (val, _) => val,
        'trend': (val, _) => val,
        'count': (val, _) => val.toLocaleString(),
        'dividend': (val, _) => val.toLocaleString(),
        'value': (val, _) => val.toLocaleString(),
        'diff': (val, _) => val.toLocaleString(),
      };
      const totals = {
        count: 0,
        dividend: 0,
        value: 0,
        diff: 0,
      };
      tbody.innerHTML = '';
      // Set each sector
      sectors.forEach((item, idx) => {
        const clone = template.content.cloneNode(true);

        for (const [key, callback] of Object.entries(nodeList)) {
          const element = clone.querySelector(`.sector-${key}`);
          const val = item[key];
          element.textContent = callback(val, idx);

          if ((key === 'diff') && (val < 0)) {
            element.classList.add('text-danger');
          }
        }
        totals.count += item.count;
        totals.dividend += item.dividend;
        totals.value += item.value;
        totals.diff += item.diff;
        tbody.appendChild(clone);
      });
      // Set total value
      ['count', 'dividend', 'value', 'diff'].forEach((key) => {
        const element = tfoot.querySelector(`th > span[name="total-sector-${key}"]`);
        const val = totals[key];
        element.textContent = val.toLocaleString();

        if ((key === 'diff') && (val < 0)) {
          element.classList.add('text-danger');
        }
        else {
          element.classList.remove('text-danger');
        }
      });
    })();
  };
  const drawPieChart = (chart, target, asset) => {
    const context = document.getElementById(target);

    if (chart) {
      chart.destroy();
    }
    chart = new Chart(context, {
      type: 'pie',
      data: {
        labels: asset.labels,
        datasets: asset.datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false,
          },
          title: {
            display: true,
            text: asset.title,
          },
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                const hiddens = Object.entries(tooltipItem.chart._hiddenIndices)
                                      .filter(([key, value]) => value)
                                      .map(([idx, _]) => Number(idx));
                const targets = tooltipItem.dataset.data.filter((_, idx) => !hiddens.includes(idx));
                const total = targets.reduce((acc, val) => acc + val, 0.0);
                const ratio = (tooltipItem.raw + 0.0) / total * 100.0;
                const score = `${tooltipItem.formattedValue}(${ratio.toFixed(2)}%)`;
                const out = `${tooltipItem.dataset.label}: ${score}`;

                return out;
              },
            },
          },
        },
      },
    });

    return chart;
  };
  const drawBarChart = (chart, target, asset) => {
    const context = document.getElementById(target);
    const widthThreshold = 768;
    const currentWidth = window.screen.availWidth;
    const judgement = (currentWidth <= widthThreshold) ? true : false;

    if (chart) {
      chart.destroy();
    }
    chart = new Chart(context, {
      type: 'bar',
      data: {
        labels: asset.labels,
        datasets: asset.datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
          y: {
            beforeBuildTicks: function (axis) {
              axis.chart.options.scales.y.ticks.autoSkip = judgement;
            },
            ticks: {
              autoSkip: false,
              maxTicksLimit: asset.labels.length,
              callback: function(value, index, ticks) {
                const maxDisplayLen = 5;
                const label = this.getLabelForValue(value);
                const condition = judgement && (label.length > maxDisplayLen);
                const out = condition ? `${label.slice(0, maxDisplayLen)}...` : label;

                return out;
              },
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
          title: {
            display: true,
            text: asset.title,
          },
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                const label = tooltipItem.dataset.label;
                const val = tooltipItem.formattedValue;
                const out = `${label}: ${val}`;

                return out;
              },
            },
          },
        },
      },
    });

    return chart;
  };
  // Define initialization function
  const init = () => {
    const _sortAlgorithm = (sortType) => {
      const types = {
        none: 0,
        asc: 1,
        desc: -1,
      };
      const sign = types[sortType];
      // lv: left-value, rv: right-value
      if (sign === 0) {
        return ((lv, rv) => 0);
      }
      else {
        return ((lv, rv) => (lv > rv) ? sign : ((lv < rv) ? (-sign) : 0));
      }
    };
    // Define chart's variables
    let stockPortfolioChart = null;
    let dividendPortfolioChart = null;
    let sectorPriceChart = null;
    let sectorDividendChart = null;
    let trendPriceChart = null;
    let trendDividendChart = null;
    let assetDiffChart = null;
    // Define callback
    const _callback = (snapshot, sortType, collectionType) => {
      const uuid = snapshot.value;
      const data = JSON.parse(document.getElementById(uuid).textContent);
      const sortFunction = _sortAlgorithm(sortType.value);
      // Create relevant data
      const output = createChartData(data, sortFunction, collectionType.value);
      // Update table
      updateTable(output.records, output.sectors);
      // Draw charts
      stockPortfolioChart = drawPieChart(stockPortfolioChart, 'stock-portfolio-chart', output.stockPortfolioData);
      dividendPortfolioChart = drawPieChart(dividendPortfolioChart, 'dividend-portfolio-chart', output.dividendPortfolioData);
      sectorPriceChart = drawPieChart(sectorPriceChart, 'sector-price-chart', output.sectorPriceData);
      sectorDividendChart = drawPieChart(sectorDividendChart, 'sector-dividend-chart', output.sectorDividendData);
      trendPriceChart = drawPieChart(trendPriceChart, 'trend-price-chart', output.trendPriceData);
      trendDividendChart = drawPieChart(trendDividendChart, 'trend-dividend-chart', output.trendDividendData);
      assetDiffChart = drawBarChart(assetDiffChart, 'asset-diff-chart', output.assetDiffData);
    };
    // Add event for each element
    const snapshot = document.getElementById('all-snapshots');
    const sortType = document.getElementById('sort-type');
    const collectionType = document.getElementById('collection-type');
    snapshot.addEventListener('change', () => _callback(snapshot, sortType, collectionType));
    sortType.addEventListener('change', () => _callback(snapshot, sortType, collectionType));
    collectionType.addEventListener('change', () => _callback(snapshot, sortType, collectionType));
    window.addEventListener('resize', () => snapshot.dispatchEvent(new Event('change')));
    // Call initial event
    snapshot.dispatchEvent(new Event('change'));
  };
  //
  // Add DOM event
  //
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
{% endblock %}
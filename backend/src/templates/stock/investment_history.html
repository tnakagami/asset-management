{% extends 'base.html' %}
{% load i18n %}

{% block header %}
{# <link href="https://cdn.jsdelivr.net/npm/dual-listbox/dist/dual-listbox.css" rel="stylesheet" /> #}
<style>
  .dual-listbox {
    width: 100%;
    margin-bottom: 1rem;
  }
  .dual-listbox .dual-listbox__container {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .dual-listbox .dual-listbox__available,
  .dual-listbox .dual-listbox__selected {
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    overflow-y: auto;
    padding: 0;
    margin-top: 0;
    width: 100%;
    height: 15rem;
    background-color: #fff;
  }
  .dual-listbox ul.dual-listbox__available,
  .dual-listbox ul.dual-listbox__selected {
    margin-block-end: 0;
    padding-inline-start: 0;
  }
  .dual-listbox .dual-listbox__buttons {
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    padding: 0;
    margin: 0.5rem;
  }
  .dual-listbox__buttons span {
    display: inline-block;
    transform: rotate(90deg);
  }
  .dual-listbox .dual-listbox__title {
    padding: 0.5rem;
    font-size: 120%;
    font-weight: 700;
    border-width: 1px;
    margin-top: 0.5rem;
  }
  .dual-listbox .dual-listbox__item {
    display: block;
    padding: 0.5rem;
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid #efefef;
    transition: background-color 0.2s ease;

    &.dual-listbox__item--selected {
        background-color: #63ccfdb3;
    }
  }
  .dual-listbox .dragging {
    opacity: 0.5;
    background-color: rgb(209, 213, 219);
  }
  .dual-listbox .drop-in {
    border: 1px solid rgb(17, 24, 39);
  }
  .dual-listbox .drop-above {
    border: 0;
    border-top: 1px solid #7c90ff
  }

  @media (min-width: 992px) {
    .dual-listbox .dual-listbox__container {
      display: grid;
      grid-template-columns: repeat(11, minmax(0, 1fr));
      gap: 1rem;
    }
    .dual-listbox__container > div:nth-of-type(odd) {
      grid-column: span 5 / span 5;
    }
    .dual-listbox .dual-listbox__buttons {
      flex-direction: column;
      justify-content: center;
      align-items: center;
      grid-column: span 1 / span 1;
      margin: 0;
    }
    .dual-listbox__buttons span {
      display: inline-block;
      transform: rotate(0deg);
    }
  }
</style>
{% endblock %}

{% block content %}
{% include 'breadcrumbs.html' with title=_("Investment history") %}
<div class="row justify-content-center">
  <div class="col">
  {% if snapshots %}
  <div class="row row-cols-1 g-2">
    <div class="col">
      <p class="fs-4">{% trans "Target snapshots" %}</p>
      <select
        name="snapshots"
        id="snapshots"
        data-available="{% trans 'All snapshots' %}"
        data-selected="{% trans 'Selected snapshots' %}"
      ></select>
    </div>
    <div class="col">
      <button
        type="button"
        id="update-graph"
        class="btn btn-primary w-100 custom-boxshadow"
      >
        {% trans "Update graph" %}
      </button>
    </div>
  </div>
  <div class="row row-cols-1 g-2">
    <div class="col">
      <p class="fs-4 mt-3">{% trans "Histories" %}</p>
    </div>
    <div class="col">
      <canvas id="purchased-chart" class="w-100"></canvas>
    </div>
    <div class="col">
      <canvas id="portfolio-chart" class="w-100"></canvas>
    </div>
    <div class="col">
      <canvas id="dividend-chart" class="w-100"></canvas>
    </div>
    <div class="col">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th scope="col">{% trans "Title" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Purchased price" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Evaluated price" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Diff" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Dividend (per year)" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Cash" %}</th>
            </tr>
          </thead>
          <tbody id="all-snapshot-list" class="table-group-divider">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <p>{% trans "There is no snapshots. Please add your snapshots in the following link." %}</p>
  <p>
    <a
      href="{% url 'stock:register_snapshot' %}"
      class="btn btn-outline-primary w-100 custom-boxshadow"
    >
      {% trans "Register snapshot" %}
    </a>
  </p>
  {% endif %}
  </div>
</div>

<template id="tbody-template">
<tr>
  <td scope="row" class="ss-title"></td>
  <td class="ss-purchasedPrice"></td>
  <td class="ss-stockPrice"></td>
  <td class="ss-diff"></td>
  <td class="ss-dividend"></td>
  <td class="ss-cash"></td>
</tr>
</template>
{% endblock %}

{% block bodyjs %}
{% for instance in snapshots %}
  {{ instance.get_jsonfield }}
{% endfor %}
<script src="https://cdn.jsdelivr.net/npm/dual-listbox/dist/dual-listbox.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"
        integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
(function () {
  //
  // Setup dual listbox
  //
  const setupDualListbox = (elementName, options) => {
    const element = document.querySelector(elementName);
    const dualListbox = new DualListbox(element, {
      availableTitle: element.dataset.available,
      selectedTitle:  element.dataset.selected,
      sortable: true,
      upButtonText: '{% trans "Up" %}',
      downButtonText: '{% trans "Down" %}',
      draggable: true,
      enableDoubleClick: true,
      options: options,
    });
    // Update css
    dualListbox.search_left.classList.remove('dual-listbox__search');
    dualListbox.search_left.classList.add('form-control', 'px-2');
    dualListbox.search_right.classList.remove('dual-listbox__search');
    dualListbox.search_right.classList.add('form-control', 'px-2');
    const textPairs = Object.freeze({
      add_button: '>',
      add_all_button: '>>',
      remove_button: '<',
      remove_all_button: '<<',
    });
    // Replace original css setting to bootstrap-based one
    for (const [name, text] of Object.entries(textPairs)) {
      const text = textPairs[name];
      dualListbox[name].classList.remove('dual-listbox__button');
      dualListbox[name].classList.add('btn', 'btn-outline-dark', 'w-100', 'h-100', 'm-2');
      dualListbox[name].innerHTML = `<span>${text}</span>`
    }

    return dualListbox;
  };

  //
  // Create chart data based on snapshot
  //
  const createChartData = (indices, options) => {
    const getRecords = (data) => {
      const purchasedPairs = {};
      // Collect each stock data
      const baseStocks = data.purchased_stocks.map((record) => {
        const _scaler = (val) => val * record.count;
        const targetStock = record.stock;
        const stockPrice = targetStock.price;
        const pStockPrice = record.price;
        const diff = Math.floor(_scaler(stockPrice - pStockPrice));

        return {
          code: targetStock.code,
          dividend: _scaler(targetStock.dividend),
          price: _scaler(record.price),
          diff: diff,
        };
      });
      // Concatenate same code data
      for (const item of baseStocks) {
        const code = item.code;

        if (Object.hasOwn(purchasedPairs, code)) {
          purchasedPairs[code].dividend += item.dividend;
          purchasedPairs[code].price += item.price;
          purchasedPairs[code].diff += item.diff;
        }
        else {
          purchasedPairs[code] = {
            dividend: item.dividend,
            price: item.price,
            diff: item.diff,
          }
        }
      }
      const output = [{
        dividend: 0,
        price: data.cash.balance,
        diff: 0,
      }].concat(Object.values(purchasedPairs));

      return output;
    }
    const getTotal = (arr, callback) => arr.reduce((acc, item) => acc + callback(item), 0);
    // Load relevant data
    const records = indices.map((idx) => options[idx].value)
                           .map((uuid) => JSON.parse(document.getElementById(uuid).textContent))
                           .map(getRecords);
    const snapshotNameList = indices.map((idx) => options[idx].text);
    const histories = {
      ssName: snapshotNameList,
      purchased: records.map((arr) => getTotal(arr.slice(1), (item) => item.price)),
      portfolio: records.map((arr) => getTotal(arr.slice(1), (item) => item.price + item.diff)),
      diff:      records.map((arr) => getTotal(arr.slice(1), (item) => item.diff)),
      dividend:  records.map((arr) => getTotal(arr.slice(1), (item) => item.dividend)),
      cash:      records.map((arr) => arr[0].price),
    }
    // Create output
    const output = {
      purchasedHistory: {
        title: '{% trans "Purchased history" %}',
        labels: snapshotNameList,
        datasets: [{
          label: '{% trans "Purchased price" %}',
          data: histories.purchased,
          backgroundColor: '#36A2EB',
        }],
      },
      portfolioHistory: {
        title: '{% trans "Portfolio history" %}',
        labels: snapshotNameList,
        datasets: [{
          label: '{% trans "Evaluated price" %}',
          data: histories.portfolio,
          backgroundColor: '#FF6384',
        }],
      },
      dividendHistory: {
        title: '{% trans "Dividend history (per year)" %}',
        labels: snapshotNameList,
        datasets: [{
          label: '{% trans "Dividend (per year)" %}',
          data: histories.dividend,
          backgroundColor: '#9966FF',
        }],
      },
    };
    output.histories = histories;

    return output;
  };
  //
  // Update history table
  //
  const updateTable = (histories) => {
    const tbody = document.querySelector('#all-snapshot-list');
    const template = document.querySelector('#tbody-template');
    const nodeList = {
      title: histories.ssName,
      purchasedPrice: histories.purchased,
      stockPrice: histories.portfolio,
      diff: histories.diff,
      dividend: histories.dividend,
      cash: histories.cash,
    };
    tbody.innerHTML = '';
    const len = histories.purchased.length;

    for (let idx = 0; idx < len; idx++) {
      const clone = template.content.cloneNode(true);

      for (const [key, arr] of Object.entries(nodeList)) {
        const element = clone.querySelector(`.ss-${key}`);
        const val = arr[idx];
        element.textContent = (key !== 'title') ? val.toLocaleString() : val;

        if ((key === 'diff') && (val < 0)) {
          element.classList.add('text-danger');
        }
      }
      tbody.appendChild(clone);
    }
  };
  //
  // Draw bar chart
  //
  const drawBarChart = (chart, target, history) => {
    const context = document.querySelector(`#${target}`);

    if (chart) {
      chart.destroy();
    }
    chart = new Chart(context, {
      type: 'bar',
      data: {
        labels: history.labels,
        datasets: history.datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',
        plugins: {
          legend: {
            display: false,
          },
          title: {
            display: true,
            text: history.title,
          },
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                return `${tooltipItem.dataset.label}: ${tooltipItem.formattedValue}`;
              },
            },
          },
        },
      },
    });

    return chart;
  };

  const init = () => {
    // Initialize select DOM element
    const options = [{% for instance in snapshots %}
      {text: '{{ instance.title }}', value: '{{ instance.uuid }}', selected: false, endDate: '{{ instance.end_date|date:"Y-m-d" }}'},
    {% endfor %}];
    setupDualListbox('#snapshots', options);
    // Define chart's variables
    let purchasedChart = null;
    let portfolioChart = null;
    let dividendChart = null;
    // Add click event
    const updateGraph = document.querySelector('#update-graph');
    updateGraph.addEventListener('click', async (event) => {
      event.target.disabled = true;

      // Sort function
      const compare = (le, re) => {
        // le: left element, re: right element
        // lv: left value,   rv: right value
        const lv = (new Date(le.endDate)).getTime();
        const rv = (new Date(re.endDate)).getTime();
        if      (lv > rv) { return  1; }
        else if (lv < rv) { return -1; }
        else              { return  0; }
      };
      const selectedOptions = (() => {
        const ssElem = document.querySelector('ul.dual-listbox__selected');
        const requestedUUIDs = Array.from(ssElem.querySelectorAll('li')).map((item) => item.dataset.id);
        const targets = options.filter((_dict) => requestedUUIDs.includes(_dict.value));

        return targets;
      })();
      const indices = selectedOptions.map((_, idx) => idx);
      const sortedIndices = indices.sort((li, ri) => compare(selectedOptions[li], selectedOptions[ri]));
      // Create chart data
      const output = createChartData(sortedIndices, selectedOptions);
      // Update table
      updateTable(output.histories);
      // Draw charts
      purchasedChart = drawBarChart(purchasedChart, 'purchased-chart', output.purchasedHistory);
      portfolioChart = drawBarChart(portfolioChart, 'portfolio-chart', output.portfolioHistory);
      dividendChart  = drawBarChart(dividendChart,  'dividend-chart',  output.dividendHistory);

      event.target.disabled = false;
    });
  };
  // Add DOM event
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
{% endblock %}
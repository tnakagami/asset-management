{% extends 'base.html' %}
{% load i18n %}

{% block header %}
{# <link href="https://cdn.jsdelivr.net/npm/dual-listbox/dist/dual-listbox.css" rel="stylesheet" /> #}
<style>
  .dual-listbox {
    width: 100%;
    margin-bottom: 1rem;
  }
  .dual-listbox .dual-listbox__container {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .dual-listbox .dual-listbox__available,
  .dual-listbox .dual-listbox__selected {
    border: 1px solid #ddd;
    border-radius: 0.375rem;
    overflow-y: auto;
    padding: 0;
    margin-top: 0;
    width: 100%;
    height: 15rem;
    background-color: #fff;
  }
  .dual-listbox ul.dual-listbox__available,
  .dual-listbox ul.dual-listbox__selected {
    margin-block-end: 0;
    padding-inline-start: 0;
  }
  .dual-listbox .dual-listbox__buttons,
  .dual-listbox .custom-listbox-buttons {
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    padding: 0;
    margin: 0.5rem;
  }
  .dual-listbox__buttons span {
    display: inline-block;
    transform: rotate(90deg);
  }
  .dual-listbox .dual-listbox__title {
    padding: 0.5rem;
    font-size: 120%;
    font-weight: 700;
    border-width: 1px;
    margin-top: 0.5rem;
  }
  .dual-listbox .dual-listbox__item {
    display: block;
    padding: 0.5rem;
    cursor: pointer;
    user-select: none;
    border-bottom: 1px solid #efefef;
    transition: background-color 0.2s ease;

    &.dual-listbox__item--selected {
        background-color: #63ccfdb3;
    }
  }
  .dual-listbox .dragging {
    opacity: 0.5;
    background-color: rgb(209, 213, 219);
  }
  .dual-listbox .drop-in {
    border: 1px solid rgb(17, 24, 39);
  }
  .dual-listbox .drop-above {
    border: 0;
    border-top: 1px solid #7c90ff
  }

  @media (min-width: 992px) {
    .dual-listbox .dual-listbox__container {
      display: grid;
      grid-template-columns: repeat(11, minmax(0, 1fr));
      grid-template-rows: auto minmax(0, 1fr);
      gap: 1rem;
    }
    .dual-listbox__container > div:nth-of-type(odd) {
      grid-column: span 5 / span 5;
    }
    .dual-listbox .dual-listbox__buttons {
      flex-direction: column;
      justify-content: center;
      align-items: center;
      grid-column: span 1 / span 1;
      margin: 0;
    }
    .dual-listbox .custom-listbox-buttons {
      justify-content: center;
      align-items: center;
      grid-column: 1 / 12;
    }
    .dual-listbox__buttons span {
      display: inline-block;
      transform: rotate(0deg);
    }
  }

  /* For Chart.js */
  .wrap-bar-chart {
    position: relative;
    height: 100vh;
  }
</style>
{% endblock %}

{% block content %}
{% include 'breadcrumbs.html' with title=_("Investment history") %}
<div class="row justify-content-center">
  <div class="col">
  {% if snapshots %}
  <div class="row row-cols-1 g-2">
    <div class="col">
      <p class="fs-4">{% trans "Target snapshots" %}</p>
      <select
        name="snapshots"
        id="snapshots"
        data-available="{% trans 'All snapshots' %}"
        data-selected="{% trans 'Selected snapshots' %}"
        data-uptxt="{% trans 'Move selected item up' %}"
        data-downtxt="{% trans 'Move selected item down' %}"
      ></select>
    </div>
    <div class="col">
      <p class="fs-5">{% trans "Sort type" %}</p>
      <select name="sortType" id="sort-type" class="form-control">
        <option value="none" data-type="none">{% trans "Without sorting" %}</option>
        <option value="priority" data-type="asc">{% trans "Priority (ASC)" %}</option>
        <option value="priority" data-type="desc">{% trans "Priority (DESC)" %}</option>
        <option value="startDate" data-type="asc">{% trans "Start date (ASC)" %}</option>
        <option value="startDate" data-type="desc">{% trans "Start date (DESC)" %}</option>
        <option value="endDate" data-type="asc" selected>{% trans "End date (ASC)" %}</option>
        <option value="endDate" data-type="desc">{% trans "End date (DESC)" %}</option>
      </select>
    </div>
    <div class="col">
      <button
        type="button"
        id="update-graph"
        class="btn btn-primary w-100 custom-boxshadow"
      >
        {% trans "Update graph" %}
      </button>
    </div>
  </div>
  <div class="row row-cols-1 g-2">
    <div class="col">
      <p class="fs-4 mt-3">{% trans "Histories" %}</p>
    </div>
    <div class="col wrap-bar-chart">
      <canvas id="portfolio-chart" class="w-100"></canvas>
    </div>
    <div class="col wrap-bar-chart">
      <canvas id="dividend-chart" class="w-100"></canvas>
    </div>
    <div class="col">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th scope="col">{% trans "Title" %}</th>
              <th scope="col" class="text-nowrap">{% trans "#Stocks" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Total counts" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Purchased price" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Evaluated price" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Diff" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Dividend (per year)" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Dividend yield" %}</th>
              <th scope="col" class="text-nowrap">{% trans "Cash" %}</th>
            </tr>
          </thead>
          <tbody id="all-snapshot-list" class="table-group-divider">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <p>{% trans "There is no snapshots. Please add your snapshots in the following link." %}</p>
  <p>
    <a
      href="{% url 'stock:register_snapshot' %}"
      class="btn btn-outline-primary w-100 custom-boxshadow"
    >
      {% trans "Register snapshot" %}
    </a>
  </p>
  {% endif %}
  </div>
</div>

<template id="tbody-template">
<tr>
  <td scope="row"><span class="ss-title"></span></td>
  <td><span class="ss-count"></span></td>
  <td><span class="ss-total"></span></td>
  <td><span class="ss-purchasedPrice"></span></td>
  <td><span class="ss-stockPrice"></span></td>
  <td><span class="ss-diff"></span></td>
  <td><span class="ss-dividend"></span></td>
  <td><span class="ss-yield"></span>&#37;</td>
  <td><span class="ss-cash"></span></td>
</tr>
</template>
{% endblock %}

{% block bodyjs %}
{% for instance in snapshots %}
  {{ instance.get_jsonfield }}{% endfor %}
<script src="https://cdn.jsdelivr.net/npm/dual-listbox/dist/dual-listbox.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"
        integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3ZSTk7kajkaj4D292NLuduDCO1c/NT8Id+jE58KYLKT7hXnbtryGmMg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
(function () {
  //
  // Setup dual listbox
  //
  const setupDualListbox = (elementId, options) => {
    const element = document.getElementById(elementId);
    const dualListbox = new DualListbox(element, {
      availableTitle: element.dataset.available,
      selectedTitle:  element.dataset.selected,
      draggable: false,
      enableDoubleClick: true,
      options: options,
      {% comment %}
      showSortButtons: true,
      upButtonText: element.dataset.uptxt,
      downButtonText: element.dataset.downtxt,
      {% endcomment %}
    });
    // Add search field's events
    dualListbox.addEventListener('added', (event) => {
      dualListbox.search_left.focus();
      dualListbox.search_left.dispatchEvent(new Event('change'));
    });
    dualListbox.addEventListener('removed', (event) => {
      dualListbox.search_right.focus();
      dualListbox.search_right.dispatchEvent(new Event('change'));
    });
    dualListbox.search_left.addEventListener('focusin', (event) => {
      dualListbox.search_right.value = '';
      dualListbox.search_right.dispatchEvent(new Event('change'));
    });
    dualListbox.search_right.addEventListener('focusin', (event) => {
      dualListbox.search_left.value = '';
      dualListbox.search_left.dispatchEvent(new Event('change'));
    });
    // Update sort function
    dualListbox.sortFunction = (leftOpt, rightOpt) => {
      const lv = leftOpt.order || 0;
      const rv = rightOpt.order || 0;
      const out = (lv < rv) ? (-1) : ((lv > rv) ? 1 : 0);

      return out;
    };
    // Update css
    dualListbox.search_left.classList.remove('dual-listbox__search');
    dualListbox.search_left.classList.add('form-control', 'px-2');
    dualListbox.search_right.classList.remove('dual-listbox__search');
    dualListbox.search_right.classList.add('form-control', 'px-2');
    const textPairs = Object.freeze({
      add_button: '>',
      add_all_button: '>>',
      remove_button: '<',
      remove_all_button: '<<',
    });
    // Replace original css setting to bootstrap-based one
    for (const [name, text] of Object.entries(textPairs)) {
      dualListbox[name].classList.remove('dual-listbox__button');
      dualListbox[name].classList.add('btn', 'btn-outline-dark', 'w-100', 'h-100', 'm-2');
      dualListbox[name].innerHTML = `<span>${text}</span>`;
    }
    {% comment %}
    // Replace original css to sort buttons
    const lastChild = dualListbox.dualListBoxContainer.lastChild;
    const sortBtns = lastChild.querySelectorAll('button');
    for (const btn of sortBtns) {
      btn.classList.remove('dual-listbox__button');
      btn.classList.add('btn', 'btn-outline-dark', 'w-100', 'h-100', 'm-2');
      // Remove event listener
      const clone = btn.cloneNode(true);
      btn.replaceWith(clone);
      // Add new event listener
      clone.addEventListener('click', (event) => {
        event.preventDefault();
        const getSelectedItems = () => document.querySelectorAll('.dual-listbox__selected > li');
        const self = dualListbox;
        const query = 'dual-listbox__item--selected';
        const selected = document.querySelector(`.${query}`);
        // Selected item exists
        if (selected) {
          const oldIndex = self.options.findIndex((opt) => opt.value == selected.dataset.id);
          const newIndex = (btn.innerText === self.upButtonText) ? (oldIndex - 1) : (oldIndex + 1);
          const selectedItems = getSelectedItems();
          // Target index is valid
          if ((0 <= newIndex) && (newIndex < selectedItems.length)) {
            const cutOptions = self.options.splice(oldIndex, 1);
            self.options.splice(newIndex, 0, cutOptions[0]);
            self.updateAvailableListbox();
            self.updateSelectedListbox();
            self.syncSelect();
            // Update selected status
            for (const item of getSelectedItems()) {
              if (item.dataset.id === selected.dataset.id) {
                item.classList.add(query);
                break;
              }
            }
          }
        }
      });
    }
    lastChild.classList.remove('dual-listbox__buttons');
    lastChild.classList.add('custom-listbox-buttons');
    {% endcomment %}

    return dualListbox;
  };

  //
  // Create chart data based on snapshot
  //
  const createChartData = (indices, options) => {
    const getRecords = (data) => {
      const purchasedPairs = {};
      // Collect each stock data
      const baseStocks = data.purchased_stocks.map((record) => {
        const _scaler = (val) => val * record.count;
        const targetStock = record.stock;
        const stockPrice = targetStock.price;
        const pStockPrice = record.price;
        const diff = _scaler(stockPrice) - _scaler(pStockPrice);

        return {
          code: targetStock.code,
          dividend: _scaler(targetStock.dividend),
          price: _scaler(record.price),
          count: record.count,
          diff: diff,
        };
      });
      // Concatenate same code data
      for (const item of baseStocks) {
        const code = item.code;

        if (Object.hasOwn(purchasedPairs, code)) {
          purchasedPairs[code].dividend += item.dividend;
          purchasedPairs[code].price += item.price;
          purchasedPairs[code].diff += item.diff;
          purchasedPairs[code].count += item.count;
        }
        else {
          purchasedPairs[code] = {
            dividend: item.dividend,
            price: item.price,
            diff: item.diff,
            count: item.count,
          };
        }
      };
      const output = [{
        dividend: 0,
        price: data.cash.balance,
        diff: 0,
        count: 0,
      }].concat(Object.values(purchasedPairs));

      return output;
    }
    const getTotal = (arr, callback) => arr.reduce((acc, item) => acc + callback(item), 0);
    // Load relevant data
    const records = indices.map((idx) => options[idx].value)
                           .map((uuid) => JSON.parse(document.getElementById(uuid).textContent))
                           .map(getRecords);
    const snapshotNameList = indices.map((idx) => options[idx].text);
    const histories = {
      ssName:    snapshotNameList,
      count:     records.map((arr) => arr.slice(1).length),
      total:     records.map((arr) => getTotal(arr.slice(1), (item) => item.count)),
      purchased: records.map((arr) => getTotal(arr.slice(1), (item) => item.price)),
      current:   records.map((arr) => getTotal(arr.slice(1), (item) => item.price + item.diff)),
      diff:      records.map((arr) => getTotal(arr.slice(1), (item) => item.diff)),
      dividend:  records.map((arr) => getTotal(arr.slice(1), (item) => item.dividend)),
      yield:     [],
      cash:      records.map((arr) => arr[0].price),
    };
    histories.yield = histories.dividend.map((dividend, idx) => {
      const ratio = dividend / histories.purchased[idx] * 100.0;
      const ret = ratio.toFixed(2);

      return ret;
    });
    // Create output
    const output = {
      portfolioHistory: {
        title: '{% trans "Portfolio history" %}',
        labels: snapshotNameList,
        datasets: [{
          label: '{% trans "Purchased price" %}',
          data: histories.purchased,
          backgroundColor: '#36A2EB',
        }, {
          label: '{% trans "Evaluated price" %}',
          data: histories.current,
          backgroundColor: '#FF6384',
        }],
      },
      dividendHistory: {
        title: '{% trans "Dividend history (per year)" %}',
        labels: snapshotNameList,
        datasets: [{
          label: '{% trans "Dividend (per year)" %}',
          data: histories.dividend,
          backgroundColor: '#9966FF',
        }],
      },
    };
    output.histories = histories;

    return output;
  };

  //
  // Update history table
  //
  const updateTable = (histories) => {
    const tbody = document.getElementById('all-snapshot-list');
    const template = document.getElementById('tbody-template');
    const nodeList = {
      title: histories.ssName,
      count: histories.count,
      total: histories.total,
      purchasedPrice: histories.purchased,
      stockPrice: histories.current,
      diff: histories.diff,
      dividend: histories.dividend,
      yield: histories.yield,
      cash: histories.cash,
    };
    const len = histories.ssName.length;
    tbody.innerHTML = '';

    for (let idx = 0; idx < len; idx++) {
      const clone = template.content.cloneNode(true);

      for (const [key, arr] of Object.entries(nodeList)) {
        const element = clone.querySelector(`.ss-${key}`);
        const val = arr[idx];
        element.textContent = (key !== 'title') ? val.toLocaleString() : val;

        if ((key === 'diff') && (val < 0)) {
          element.classList.add('text-danger');
        }
      }
      tbody.appendChild(clone);
    }
  };

  //
  // Draw bar chart
  //
  const drawBarChart = (chart, target, history) => {
    const context = document.getElementById(target);
    const widthThreshold = 768;
    const currentWidth = window.screen.availWidth;
    const judgement = (currentWidth <= widthThreshold) ? true : false;

    if (chart) {
      chart.destroy();
    }
    chart = new Chart(context, {
      type: 'bar',
      data: {
        labels: history.labels,
        datasets: history.datasets,
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        scales: {
          y: {
            beforeBuildTicks: function (axis) {
              axis.chart.options.scales.y.ticks.autoSkip = judgement;
            },
            ticks: {
              autoSkip: false,
              maxTicksLimit: history.labels.length,
              callback: function(value, index, ticks) {
                const maxDisplayLen = 3;
                const label = this.getLabelForValue(value);
                const condition = judgement && (label.length > maxDisplayLen);
                const out = condition ? `${label.slice(0, maxDisplayLen)}...` : label;

                return out;
              },
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
          title: {
            display: true,
            text: history.title,
          },
          tooltip: {
            callbacks: {
              label: function (tooltipItem) {
                return `${tooltipItem.dataset.label}: ${tooltipItem.formattedValue}`;
              },
            },
          },
        },
      },
    });

    return chart;
  };

  //
  // Initialization
  //
  const init = () => {
    // Initialize select DOM element
    const options = [{% for instance in snapshots %}
      {
        text: '{{ instance.title }}',
        value: '{{ instance.uuid }}',
        order: {{ forloop.counter }},
        selected: false,
        priority: {{ instance.priority }},
        startDate: new Date('{{ instance.start_date|date:"c" }}'),
        endDate: new Date('{{ instance.end_date|date:"c" }}'),
      },{% endfor %}
    ];
    setupDualListbox('snapshots', options);
    // Define chart's variables
    let portfolioChart = null;
    let dividendChart = null;
    //
    // Add click event
    //
    const updateGraph = document.getElementById('update-graph');
    updateGraph.addEventListener('click', (event) => {
      event.target.disabled = true;

      // Define sort function
      const sortAlgorithm = (() => {
        // Get sort type
        const sortType = document.getElementById('sort-type');
        const key = sortType.value;
        const orderingType = sortType.selectedOptions[0].dataset.type.toLowerCase();
        const sign = (orderingType === 'asc') ? 1 : (-1);
        const compare = (lv, rv) => ((lv > rv) ? sign : ((lv < rv) ? (-sign) : 0));
        //
        // le: left element, re: right element
        // lv: left value,   rv: right value
        //
        if (key === 'none') {
          return (le, re) => 0;
        }
        else if (key === 'priority') {
          return (le, re) => compare(le.priority, re.priority);
        }
        // In the case of startDate or endDate
        else {
          return (le, re) => compare(le[key].getTime(), re[key].getTime());
        }
      })();
      // Get selected options and sorted ones
      const selectedOpts = (() => {
        const ssElem = document.querySelector('ul.dual-listbox__selected');
        const requestedUUIDs = Array.from(ssElem.querySelectorAll('li')).map((item) => item.dataset.id);
        const targets = options.filter((elem) => requestedUUIDs.includes(elem.value));

        return targets;
      })();
      const sortedIndices = selectedOpts.map((_, idx) => idx)
                                        .sort((li, ri) => sortAlgorithm(selectedOpts[li], selectedOpts[ri]));
      // Create chart data
      const output = createChartData(sortedIndices, selectedOpts);
      // Update table
      updateTable(output.histories);
      // Draw charts
      portfolioChart = drawBarChart(portfolioChart, 'portfolio-chart', output.portfolioHistory);
      dividendChart  = drawBarChart(dividendChart,  'dividend-chart',  output.dividendHistory);

      event.target.disabled = false;
    });
    window.addEventListener('resize', () => updateGraph.dispatchEvent(new Event('click')));
  };
  //
  // Add DOM event
  //
  document.addEventListener('DOMContentLoaded', init);
})();
</script>
{% endblock %}